<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>BilimselMutfak RadyoV3</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            background: linear-gradient(180deg,#0b1c2d,#102a44);
            font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Arial;
            display: flex;
            justify-content: center;
            color: #e3f2fd;
            height: 100vh;
        }

        .app {
            width: 390px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        header {
            background: #0a2540;
            padding: 16px;
            text-align: center;
            font-size: 22px;
        }

        .mode-bar {
            display: grid;
            grid-template-columns: 48px 48px 1fr 48px 48px;
            align-items: center;
            padding: 8px;
            background: #102a44;
        }

        .mode-btn {
            text-align: center;
            font-size: 11px;
            cursor: pointer;
        }

            .mode-btn span {
                font-size: 22px;
                display: block;
            }

        #statusContainer {
            overflow: hidden;
            width: 100%;
            height: 18px;
            position: relative;
        }

        .scroll-text {
            position: absolute;
            white-space: nowrap;
            font-size: 12px;
            color: #90caf9;
            animation: scroll-left 10s linear infinite;
        }

        @keyframes scroll-left {
            0% {
                transform: translateX(100%)
            }

            100% {
                transform: translateX(-100%)
            }
        }

        .content {
            flex: 0;
        }

        #radioArea {
            padding: 16px 16px 8px;
            display: grid;
            grid-template-columns: repeat(2,1fr);
            gap: 14px;
        }

        .radio-btn {
            background: #132f4c;
            border-radius: 16px;
            padding: 14px;
            text-align: center;
            font-weight: 600;
            cursor: pointer;
            transition: .25s;
        }

            .radio-btn:hover {
                background: #1b3f66;
            }

            .radio-btn.active {
                background: #1e88e5;
                box-shadow: 0 0 12px rgba(30,136,229,.9);
            }

        #gameArea {
            display: none;
            justify-content: center;
            padding: 12px 0;
        }

        .game-wrapper {
            position: relative;
            width: 100%;
            max-width: 360px;
            height: 360px;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            background: #081626;
            border-radius: 18px;
        }

        #gameHud {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            font-size: 14px;
            z-index: 5;
        }

        #gameOverlay {
            position: absolute;
            inset: 0;
            background: rgba(8,22,38,.85);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 18px;
            z-index: 10;
            flex-direction: column;
            gap: 8px;
        }

            #gameOverlay .score-display {
                color: #fff;
                font-size: 18px;
                margin-bottom: 6px;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            #gameOverlay button {
                background: #1e88e5;
                color: #fff;
                border: none;
                border-radius: 12px;
                padding: 12px 0;
                font-size: 16px;
                cursor: pointer;
                width: 150px;
                transition: .25s;
            }

                #gameOverlay button:hover {
                    background: #1565c0;
                }

            #gameOverlay .socials {
                display: flex;
                justify-content: space-between;
                width: 150px;
                margin-top: 6px;
            }

                #gameOverlay .socials span {
                    font-size: 20px;
                    cursor: pointer;
                }

        .controls {
            background: #0a2540;
            padding: 12px;
            display: flex;
            justify-content: space-between;
        }

        .audio-panel, .function-panel, .game-controls {
            width: 33%;
        }

        .audio-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .visualizer {
            height: 42px;
            background: #102a44;
            border-radius: 12px;
            overflow: hidden;
        }

            .visualizer canvas {
                width: 100%;
                height: 100%;
                display: block;
            }

        .control-row {
            display: flex;
            gap: 10px;
        }

        .play-btn {
            background: #1e88e5;
            border: none;
            border-radius: 14px;
            padding: 8px 14px;
            font-size: 16px;
            color: #fff;
            cursor: pointer;
        }

        input[type=range] {
            flex: 1;
        }

        .function-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .function-btn {
            background: #132f4c;
            border: none;
            border-radius: 12px;
            padding: 12px;
            color: #90caf9;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .game-controls {
            display: none;
            justify-content: center;
            align-items: center;
        }

        .dir-grid {
            width: 100%;
            max-width: 120px;
            display: grid;
            grid-template-columns: repeat(3,1fr);
            grid-template-rows: repeat(2,38px);
            gap: 6px;
        }

        .dir-btn {
            background: #1e88e5;
            border: none;
            border-radius: 20px;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
        }

            .dir-btn.center {
                grid-column: 2;
                grid-row: 1;
            }

            .dir-btn.left {
                grid-column: 1;
                grid-row: 2;
            }

            .dir-btn.right {
                grid-column: 3;
                grid-row: 2;
            }

            .dir-btn.down {
                grid-column: 2;
                grid-row: 2;
            }

        footer {
            background: #0a2540;
            text-align: center;
            padding: 10px;
            font-size: 13px;
        }

        #startOverlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,.6);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: #fff;
            font-size: 22px;
            cursor: pointer;
            text-align: center;
        }

            #startOverlay span {
                background: rgba(0,0,0,.5);
                padding: 20px 30px;
                border-radius: 12px;
            }

            #startOverlay.hidden {
                display: none;
            }
        #onlineCounter {
            font-size: 12px;
            color: #7dd3fc;
            text-align: center;
            align-self: center;
            margin: 0 6px;
            user-select: none;
        }
        @keyframes onlinePulse {
            0% {
                transform: scale(1);
                opacity: 0.7;
            }

            50% {
                transform: scale(1.08);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0.85;
            }
        }

        #onlineCounter.pulse {
            animation: onlinePulse 0.6s ease;
        }
        #onlineCounter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        #onlineDot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            background-color: #ef4444; /* kƒ±rmƒ±zƒ± */
            box-shadow: 0 0 6px rgba(239, 68, 68, 0.8);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

            #onlineDot.online {
                background-color: #22c55e; /* ye≈üil */
                box-shadow: 0 0 6px rgba(34, 197, 94, 0.9);
            }

            #onlineDot.offline {
                background-color: #ef4444;
                box-shadow: 0 0 6px rgba(239, 68, 68, 0.8);
            }

    </style>
</head>
<body>
    <div class="app">
        <header>üéß BilimselMutfak ROV3</header>
        <div class="mode-bar">
            <div class="mode-btn" onclick="showGame()"><span>üéÆ</span>Oyun</div>
            <div class="mode-btn" onclick="openYT()"><span>‚ñ∂Ô∏è</span>YT</div>
            <div id="statusContainer"><div id="status" class="scroll-text">Bir radyo se√ßiniz</div></div>
            <div class="mode-btn" onclick="openIG()"><span>üì∏</span>IG</div>
            <div class="mode-btn" onclick="showRadio()"><span>üìª</span>Radyo</div>
        </div>
        <div class="content">
            <div id="radioArea">
                <div class="radio-btn" onclick="selectRadio(this,'JoyT√ºrk','https://live.powerapp.com.tr/powerturk/mpeg/icecast.audio?/;stream.mp3')">JoyT√ºrk</div>
                <div class="radio-btn" onclick="selectRadio(this,'Show Radyo','https://listen.radyotvonline.net/hls/play/adsonline_showradyo.m3u8')">Show Radyo</div>
                <div class="radio-btn" onclick="selectRadio(this,'Kƒ±ral FM','https://playerservices.streamtheworld.com/api/livestream-redirect/SUPER_FM_ITUNES.mp3')">Kƒ±ral FM</div>
                <div class="radio-btn" onclick="selectRadio(this,'Number One','https://n10101m.mediatriple.net/numberoneturk')">Number One</div>
                <div class="radio-btn" onclick="selectRadio(this,'Best FM','https://edge1.radyotvonline.net/shoutcast/play/bestfm?')">Best FM</div>
                <div class="radio-btn" onclick="selectRadio(this,'Power FM','https://live.powerapp.com.tr/powerturk/mpeg/icecast.audio?/;stream.mp3')">Power FM</div>
                <div class="radio-btn" onclick="selectRadio(this,'90‚Äôlar Pop','https://moondigitalmaster.radyotvonline.net/90lar/playlist.m3u8')">90‚Äôlar Pop</div>
                <div class="radio-btn" onclick="selectRadio(this,'Akustik','https://playerservices.streamtheworld.com/api/livestream-redirect/JOYTURK_AKUSTIK128AAC.aac?/;stream.mp3')">Akustik</div>
                <div class="radio-btn" onclick="selectRadio(this,'Ankaralƒ±','https://stream.netradyom.com/listen/radyobanko/radio.mp3/')">Ankaralƒ±</div>
                <div class="radio-btn" onclick="selectRadio(this,'Slow T√ºrk','https://radyo.duhnet.tv/ak_dtvh_slowturk')">Slow T√ºrk</div>
            </div>
            <div id="gameArea">
                <div class="game-wrapper">
                    <div id="gameHud">
                        <span id="score">Skor: 0</span><span>|</span><span id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
                    </div>
                    <canvas id="gameCanvas"></canvas>
                    <div id="gameOverlay">
                        <div class="score-display">üèÜ <span id="finalScore">0</span></div>
                        <button onclick="restartGame()">üîÑ Tekrar Oyna</button>
                        <button onclick="shareLink()">üì§ Arkada≈üƒ±na G√∂nder</button>
                        <div class="socials">
                            <span onclick="openYT()">‚ñ∂Ô∏è</span>
                            <span onclick="openIG()">üì∏</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="controls">
            <div class="audio-panel">
                <div class="visualizer"><canvas id="visCanvas"></canvas></div>
                <div id="onlineCounter">
                    <span id="onlineDot" class="offline"></span>
                    <span id="onlineText">Online Ki≈üi: 0</span>
                </div>
                <div class="control-row">
                    <button id="playBtn" class="play-btn" onclick="togglePlay()">üîá</button>
                    <input id="vol" type="range" min="0" max="1" step="0.01" value="0.8" oninput="setVolume(this.value)">
                </div>
            </div>
            <div class="function-panel" id="functionPanel">
                <button class="function-btn" onclick="sendCurrentRadio()">G√∂nder</button>
                <button class="function-btn">2. Fonksiyon</button>
            </div>
            <div class="game-controls" id="gameControls">
                <div class="dir-grid">
                    <button class="dir-btn center" onpointerdown="setDir(0,-1)">‚¨ÜÔ∏è</button>
                    <button class="dir-btn left" onpointerdown="setDir(-1,0)">‚¨ÖÔ∏è</button>
                    <button class="dir-btn right" onpointerdown="setDir(1,0)">‚û°Ô∏è</button>
                    <button class="dir-btn down" onpointerdown="setDir(0,1)">‚¨áÔ∏è</button>
                </div>
            </div>
        </div>
        <footer>¬© BilimselMutfak</footer>
        <audio id="radio" crossorigin="anonymous" playsinline muted></audio>
        <div id="startOverlay"><span>‚ñ∂Ô∏è Ba≈ülatmak i√ßin dokun</span></div>

        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

        <script>
            const radio = document.getElementById("radio");
            const playBtn = document.getElementById("playBtn");
            const status = document.getElementById("status");
            const visCanvas = document.getElementById("visCanvas");
            const vctx = visCanvas.getContext("2d");
            const vol = document.getElementById("vol");
            const startOverlay = document.getElementById("startOverlay");
            let audioCtx, analyser, source, data, currentRadioBtn = null;
            let visMode = 0; // 0=√áubuk, 1=Daire, 2=Dalga


            // Ses ekolayzƒ±rƒ± ve iOS uyumu
            function initAudio() {
                if (audioCtx) return;
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 128;
                source = audioCtx.createMediaElementSource(radio);
                source.connect(analyser);
                analyser.connect(audioCtx.destination);
                data = new Uint8Array(analyser.frequencyBinCount);
                drawVis();
            }
            function drawVis() {
                requestAnimationFrame(drawVis);
                if (!analyser) return;
                analyser.getByteFrequencyData(data);
                vctx.clearRect(0, 0, visCanvas.width, visCanvas.height);
                const w = visCanvas.width / data.length;
                for (let i = 0; i < data.length; i++) {
                    const h = (data[i] / 255) * visCanvas.height;
                    vctx.fillStyle = "#64b5f6";
                    vctx.fillRect(i * w, visCanvas.height - h, w - 1, h);
                }

                // Radyo se√ßimi ve √ßalma
            } function selectRadio(btn, name, url) {
                document.querySelectorAll(".radio-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                currentRadioBtn = btn;
                radio.src = url;
                initAudio();
                audioCtx.resume().then(() => radio.play().then(updateIcon));
                status.textContent = name + " ‚Ä¢ YAYINDA";
            }

            // Play/Pause ve ikon g√ºncelleme
            function togglePlay() {
                if (radio.muted) { radio.muted = false; radio.volume = 0.5; vol.value = 0.5; }
                if (radio.paused) audioCtx.resume().then(() => radio.play().then(updateIcon));
                else radio.pause();
                updateIcon();
            }
            function setVolume(v) { radio.volume = v; updateIcon(); }
            function updateIcon() { if (radio.paused || radio.volume == 0) playBtn.textContent = "üîá"; else if (radio.volume < 0.5) playBtn.textContent = "üîà"; else playBtn.textContent = "‚è∏Ô∏è"; }

            // Ba≈ülatmak i√ßin dokun overlay
            startOverlay.addEventListener("click", () => {
                startOverlay.classList.add("hidden");
                if (!audioCtx) initAudio();
                const firstBtn = document.querySelector("#radioArea .radio-btn");
                if (firstBtn) {
                    const urlMatch = firstBtn.getAttribute("onclick").match(/'(.*?)','(.*?)'/);
                    selectRadio(firstBtn, firstBtn.textContent, urlMatch[2]);
                    radio.muted = false;
                }
            });

            // Oyun ve fonksiyonlar
            const radioArea = document.getElementById("radioArea");
            const gameArea = document.getElementById("gameArea");
            const functionPanel = document.getElementById("functionPanel");
            const gameControls = document.getElementById("gameControls");
            const canvas = document.getElementById("gameCanvas");
            const ctx = canvas.getContext("2d");
            const scoreEl = document.getElementById("score");
            const livesEl = document.getElementById("lives");
            const overlay = document.getElementById("gameOverlay");
            const finalScore = document.getElementById("finalScore");
            const grid = 20;
            let snake, dir, food, score, lives, loop, paused = false;
            function setDir(x, y) { if ((x !== 0 && dir.x === 0) || (y !== 0 && dir.y === 0)) dir = { x, y }; }
            function resizeGame() { canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight; }
            function showGame() { radioArea.style.display = "none"; gameArea.style.display = "flex"; functionPanel.style.display = "none"; gameControls.style.display = "flex"; resizeGame(); startGame(); }
            function showRadio() { gameArea.style.display = "none"; radioArea.style.display = "grid"; gameControls.style.display = "none"; functionPanel.style.display = "flex"; }
            function startGame() { snake = [{ x: 5, y: 5 }]; dir = { x: 1, y: 0 }; food = randomPos(); score = 0; lives = 3; overlay.style.display = "none"; updateHud(); clearInterval(loop); loop = setInterval(updateGame, 180); }
            function restartGame() { startGame(); }
            function randomPos() { return { x: Math.floor(Math.random() * (canvas.width / grid)), y: Math.floor(Math.random() * (canvas.height / grid)) }; }
            function updateHud() { scoreEl.textContent = "Skor: " + score; livesEl.textContent = "‚ù§Ô∏è".repeat(lives); }
            function updateGame() { if (paused) return; const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y }; if (head.x < 0 || head.y < 0 || head.x >= canvas.width / grid || head.y >= canvas.height / grid) { lives--; updateHud(); if (lives <= 0) { clearInterval(loop); finalScore.textContent = score; overlay.style.display = "flex"; return; } paused = true; setTimeout(() => { snake = [{ x: Math.floor(Math.random() * canvas.width / grid), y: Math.floor(Math.random() * canvas.height / grid) }]; paused = false; }, 2000); return; } snake.unshift(head); if (head.x === food.x && head.y === food.y) { score += 10; food = randomPos(); updateHud(); } else snake.pop(); drawGame(); }
            function drawGame() { ctx.fillStyle = "#081626"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.fillStyle = "#e53935"; ctx.fillRect(food.x * grid, food.y * grid, grid, grid); ctx.fillStyle = "#1e88e5"; snake.forEach(s => ctx.fillRect(s.x * grid, s.y * grid, grid, grid)); }
            window.addEventListener("keydown", e => { if (e.key === "ArrowUp") setDir(0, -1); if (e.key === "ArrowDown") setDir(0, 1); if (e.key === "ArrowLeft") setDir(-1, 0); if (e.key === "ArrowRight") setDir(1, 0); if (paused && (e.key === " " || e.key === "Enter")) paused = false; });
            window.addEventListener("click", () => { if (paused) paused = false; });
            function shareLink() { window.prompt("Arkada≈üƒ±nƒ±za g√∂ndermek i√ßin linki kopyalayƒ±n:", window.location.href); }
            const openYT = () => window.open("https://www.youtube.com/@bilimselmutfak", "_blank");
            const openIG = () => window.open("https://www.instagram.com/bilimselmutfakyt/", "_blank");
            function sendCurrentRadio() { if (!currentRadioBtn) { alert("√ñnce bir radyo se√ßin!"); return; } let radioName = currentRadioBtn.textContent; let mailTo = prompt("Mail veya WhatsApp numarasƒ± girin:"); if (!mailTo) return; let subject = "Muhte≈üem bir m√ºzik tƒ±pkƒ± senin gibi :))"; let body = `Sevgili kullanƒ±cƒ±,\n\nBu radyo programƒ± BilimselMutfak YouTube kanalƒ± yapƒ±mcƒ±larƒ± tarafƒ±ndan hazƒ±rlanmƒ±≈ütƒ±r.\n\n≈ûu anda dinlediƒüiniz radyo: ${radioName}\n\nLink: ${window.location.href}`; window.open(`mailto:${mailTo}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`); }
            // üî¥ ONLINE Kƒ∞≈ûƒ∞ SAYACI
            const firebaseConfig = {
                apiKey: "AIzaSyBF5HTStOp3Wa_FD3tRT0y_JrSsotLjV6w",
                authDomain: "bilimselmutfak-radio.firebaseapp.com",
                projectId: "bilimselmutfak-radio"
            };

            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const onlineRef = db.collection("radio").doc("online");
            const onlineDot = document.getElementById("onlineDot");
            const onlineText = document.getElementById("onlineText");
            const onlineEl = document.getElementById("onlineCounter");
            const sessionId = Date.now().toString();

            async function joinRadio() {
                // Kullanƒ±cƒ±yƒ± ekle
                await onlineRef.set({
                    users: firebase.firestore.FieldValue.arrayUnion({ id: sessionId, timestamp: Date.now() })
                }, { merge: true });

                // üîπ Heartbeat: 5 saniyede bir timestamp g√ºncelle
                setInterval(async () => {
                    const doc = await onlineRef.get();
                    if (!doc.exists) return;
                    let users = doc.data().users || [];

                    // Bu kullanƒ±cƒ±nƒ±n timestamp'ini g√ºncelle
                    users = users.map(u => u.id === sessionId ? { ...u, timestamp: Date.now() } : u);

                    await onlineRef.set({ users }, { merge: true });
                }, 5000);
            }

            // üî¥ Hayalet kullanƒ±cƒ± temizleme fonksiyonu
            async function cleanGhostUsers() {
                const doc = await onlineRef.get();
                if (!doc.exists) return;

                let users = doc.data().users || [];
                const now = Date.now();

                // 15 saniyeden eski kullanƒ±cƒ±larƒ± filtrele
                users = users.filter(u => now - u.timestamp < 15000);

                await onlineRef.set({ users }, { merge: true });
            }

            async function leaveRadio() {
                await onlineRef.update({
                    users: firebase.firestore.FieldValue.arrayRemove(sessionId)
                });
            }

            let lastCount = 0;

            onlineRef.onSnapshot(doc => {
                if (doc.exists && doc.data().users) {
                    const count = doc.data().users.length;

                    onlineText.textContent = "Online Ki≈üi: " + count;

                    if (count > 0) {
                        onlineDot.classList.remove("offline");
                        onlineDot.classList.add("online");
                    } else {
                        onlineDot.classList.remove("online");
                        onlineDot.classList.add("offline");
                    }
                }
            });
            window.addEventListener("load", joinRadio);
            // Her 5 saniyede bir hayalet kullanƒ±cƒ±larƒ± temizle
            setInterval(cleanGhostUsers, 5000);
            window.addEventListener("beforeunload", leaveRadio);
        </script>
    </div>
</body>
</html>
